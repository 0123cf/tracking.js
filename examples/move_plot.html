<!doctype html>

<html>
<head>
	<title></title>

	<script type="text/javascript" src="../src/tracking.js"></script>
	<script type="text/javascript" src="js/splines.js"></script>

	<style type="text/css">
		#videoContainer {
			display: none;
		}

		.flip-horizontally {
			-moz-transform: scale(-1, 1);
			-o-transform: scale(-1, 1);
			-webkit-transform: scale(-1, 1);
			filter: FlipH;
			transform: scale(-1, 1);
		}
	</style>
</head>
<body>

<div id="videoContainer"></div>
<div id="canvasContainer"></div>

<br/>

<script>
	var vc1 = new tracking.VideoCamera({
			audio: true
		}),

		canvas1 = vc1.get('canvas'),
		canvasNode1 = canvas1.get('canvasNode'),
		context1 = canvas1.context;

	canvasNode1.classList.add('flip-horizontally');

	vc1.render('#videoContainer');
	vc1.renderVideoCanvas('#canvasContainer');

	// Plot
	var plotCanvas = new tracking.Canvas({
		// width: window.innerWidth,
		// height: window.innerHeight
	}),

	drawPoints = [];

	plotCanvas.get('canvasNode').classList.add('flip-horizontally');
	plotCanvas.render();
	// End

	var threshold = 50;

	function render() {
		var imageData = vc1.getVideoCanvasImageData(),
			cpx,
			cpy,
			cpz,
			distance,
			dx = 0,
			dy = 0,
			m,
			maxx = -1,
			maxy = -1,
			minx = Infinity,
			miny = Infinity,
			n,
			pixels = [],
			total,
			totalInliers = 0,
			x,
			y,
			diff1,
			diff2;

		canvas1.forEach(imageData, function(r, g, b, a, w, i, j) {
			diff1 = r - g;
			diff2 = b - g;

			if (diff1 >= threshold && diff2 >= threshold) {
				pixels.push(j, i);
			}
		});

		total = pixels.length;

		if (total < 30) {
			drawPoints = [];
			return;
		}

		// Flag outliers
		for (m = 0; m < total; m+=2) {
			distance = 0;

			for (n = 2; n < total; n+=2) {
				distance += tracking.math.distance(pixels[m], pixels[m+1], pixels[n], pixels[n+1]);
			}

			if (distance/total > 20) {
				pixels[m] = -1;
				pixels[m+1] = -1;
			}
		}

		for (m = 0; m < total; m+=2) {
			x = pixels[m];
			y = pixels[m+1];

			if (x > -1 && y > -1) {
				dx += x;
				dy += y;
				totalInliers++;

				if (x < minx) {
					minx = x;
				}

				if (x > maxx) {
					maxx = x;
				}

				if (y < miny) {
					miny = y;
				}

				if (y > maxy) {
					maxy = y;
				}

				context1.fillStyle = "rgb(255,0,0)";
				context1.fillRect (x, y, 3, 3);
			}
		}

		cpy = dy/totalInliers;
		cpx = dx/totalInliers;
		cpz = 60 - ((maxx - minx) + (maxy - miny))/2;

		// plotCanvas.context.fillStyle = "rgb(0, 0,0)";
		// plotCanvas.context.fillRect (cpx, cpy, 3, 3);
		drawPoints.push(cpx, cpy);
		// plotCanvas.context.clearRect(0,0,320,240);
		drawSpline(context1,drawPoints,0.5,false);
	}



	(function loop() {
		requestAnimationFrame(loop);
		render();
	}());
</script>

</body>
</html>