<!doctype html>

<html>
<head>
	<title></title>

	<script type="text/javascript" src="../src/tracking.js"></script>

	<style type="text/css">
		#videoContainer {
			display: none;
		}

		.flip-horizontally {
			-moz-transform: scale(-1, 1);
			-o-transform: scale(-1, 1);
			-webkit-transform: scale(-1, 1);
			filter: FlipH;
			transform: scale(-1, 1);
		}
	</style>
</head>
<body>

<div id="videoContainer"></div>
<div id="canvasContainer"></div>

<br/>

<script>
	var videoCamera = new tracking.VideoCamera({
			audio: true
		}),

		canvas = videoCamera.canvas,
		canvasContext = canvas.context;

	canvas.domElement.classList.add('flip-horizontally');

	videoCamera.render('#videoContainer');
	videoCamera.renderVideoCanvas('#canvasContainer');

	var euclideanDistance = function(x0, y0, x1, y1) {
		var dx = x1-x0,
			dy = y1-y0;

		return Math.sqrt(dx*dx + dy*dy);
	};

	var threshold = 50;

	function render() {
		var imageData = videoCamera.getVideoCanvasImageData(),
			cpx,
			cpy,
			cpz,
			distance,
			dx = 0,
			dy = 0,
			m,
			maxx = -1,
			maxy = -1,
			minx = Infinity,
			miny = Infinity,
			n,
			pixels = [],
			total,
			totalInliers = 0,
			x,
			y,
			diff1,
			diff2;

		canvas.forEach(imageData, function(r, g, b, a, w, i, j) {
			diff1 = r - g;
			diff2 = b - g;

			if (diff1 >= threshold && diff2 >= threshold) {
				pixels.push(j, i);
			}
		});

		total = pixels.length;

		if (total < 30) {
			return;
		}

		// Flag outliers
		for (m = 0; m < total; m+=2) {
			distance = 0;

			for (n = 2; n < total; n+=2) {
				distance += euclideanDistance(pixels[m], pixels[m+1], pixels[n], pixels[n+1]);
			}

			if (distance/total > 20) {
				pixels[m] = -1;
				pixels[m+1] = -1;
			}
		}

		for (m = 0; m < total; m+=2) {
			x = pixels[m];
			y = pixels[m+1];

			if (x > -1 && y > -1) {
				dx += x;
				dy += y;
				totalInliers++;

				if (x < minx) {
					minx = x;
				}

				if (x > maxx) {
					maxx = x;
				}

				if (y < miny) {
					miny = y;
				}

				if (y > maxy) {
					maxy = y;
				}

				canvasContext.fillStyle = "rgb(255,0,0)";
				canvasContext.fillRect (x, y, 3, 3);
			}
		}

		cpy = dy/totalInliers;
		cpx = dx/totalInliers;
		cpz = 60 - ((maxx - minx) + (maxy - miny))/2;

		// console.log(cpx, cpy, cpz);

		canvasContext.fillStyle = "rgb(0, 0,0)";
		canvasContext.fillRect (cpx, cpy, 3, 3);
	}

	(function loop() {
		requestAnimationFrame(loop);
		render();
	}());
</script>

</body>
</html>